<!--
/*
 * Copyright 2013 The Polymer Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 */
-->
<link rel="import" href="../../../more-elements/Ace/Ace.html">

<element name="pg-app">
  <link rel="stylesheet" href="css/pg-app.css" />
  <template>
    <polymer-flex-layout></polymer-flex-layout>
    <polymer-ui-sidebar-menu id="menu" label="Playground" selectedModel="{{selectedElement}}">
      <template repeat="{{elements}}">
        <polymer-ui-menu-item label="{{label}}"></polymer-ui-menu-item>
      </template>
    </polymer-ui-sidebar-menu>
    <div flex>
      <polymer-flex-layout vertical></polymer-flex-layout>
      <polymer-ui-toolbar>
        <button class="toolbar-button" on-tap="run">Run</button>
        <div flex></div>
      </polymer-ui-toolbar>
      <div flex>
        <polymer-flex-layout></polymer-flex-layout>
        <ajaxorg-ace id="ace" mode="html" theme="chrome" tabSize="2"></ajaxorg-ace>
        <div flex>
          <polymer-flex-layout vertical></polymer-flex-layout>
          <polymer-ui-toolbar theme="polymer-ui-light-theme">
            <polymer-ui-icon-button src="{{arrowImageSrc}}" on-tap="toggleMaximized"></polymer-ui-icon-button>
            <div>Output</div>
          </polymer-ui-toolbar>
          <div class="outputContainer" flex>
            <iframe id="output"></iframe>
          </div>
        </div>
      </div>
    </div>
    <polymer-meta list="{{elements}}"></polymer-meta>
  </template>
  <script>
    Polymer.register(this, {
      maximized: false,
      ready: function() {
        this.asyncMethod(function() {
          this.$.menu.selected = this.elements[0].label;
        });
        this.maximizedChanged();
      },
      toggleMaximized: function() {
        this.maximized = !this.maximized;
      },
      maximizedChanged: function() {
        this.$.ace.classList.toggle('minimized', this.maximized);
        this.arrowImageSrc = this.resolvePath('images/arrow_' + 
            (this.maximized ? 'right' : 'left')  + '.png');
      },
      selectedElementChanged: function() {
        var s = this.selectedElement.archetype.innerHTML.trim();
        // remove extra spaces in the beginning of each line
        this.$.ace.value = s.replace(/^[\s]{0,4}/gm, '');
        this.asyncMethod('run');
      },
      run: function() {
        this.$.output.src = '';
        this.asyncMethod(function() {
          var doc = this.$.output.contentDocument;
          doc.open('text/html', '');
          doc.write(this.makeOutputHTML('', this.$.ace.editor.getValue()));
          doc.close();
        }, null, 1);
      },
      makeOutputHTML: function(head, body) {
        var html = '<!DOCTYPE html>\n';
        html += '<head>\n';
        html += head || '';
        // include base scripts and css
        html += '<script src="../../polymer/polymer.js"></s' + 'cript>\n';
        html += '<link rel="stylesheet" href="../../polymer-ui-elements/basic.css">\n';
        // import elements
        html += '<link rel="import" href="elements.html">\n';
        html += '</head>\n';
        // include content
        html += '<body class="polymer-ui-body-text">\n';
        html += body || '';
        html += '\n</body>\n</html>';
        return html;
      }
    });
  </script>
</element>