<element name="td-item" extends="li" attributes="item editing" on-keyup="keyupAction" on-blur="commitAction">
  <link rel="stylesheet" href="css/td-item.css">
  <template>
    <div class="view" completed?="{{item.completed}}" showing="{{notEditing}}" on-dblclick="editAction">
      <input type="checkbox" class="toggle" checked="{{item.completed}}" on-click="itemChangeAction">
      <label>{{item.title}}</label>
      <button class="destroy" on-click="destroyAction"></button>
    </div>
    <input id="edit" class="edit" value="{{item.title}}" showing="{{editing}}">
  </template>
  <script>
    var ENTER_KEY = 13;
    var ESC_KEY = 27;
    Polymer.register(this, {
      applyAuthorStyles: true,
      editing: false,
      notEditing: true,
      editingChanged: function() {
        this.notEditing = !this.editing;
        if (this.editing) {
          this.asyncMethod(function() {
            this.oldTitle = this.item.title;
            this.$.edit.focus();
          });
          this.classList.add('editing');
        } else {
          this.item.title = this.item.title.trim();
          if (this.item.title === '') {
            this.fire('destroyitem', this.item);
          }
          this.classList.remove('editing');
        }
      },
      itemChangeAction: function() {
        // if completed property on an item was modified via the UI
        // then we notify ancestors
        // solves the problem of not being able to watch sub-objects
        // automatically via Object.observe
        this.fire('itemchanged');
      },
      editAction: function() {
        this.editing = true;
      },
      commitAction: function() {
        this.editing = false;
      },
      keyupAction: function(e) {
        if (e.keyCode === ENTER_KEY) {
          this.editing = false;
        }
        if (e.keyCode === ESC_KEY) {
          this.editing = false;
          this.item.title = this.oldTitle;
        }
      },
      destroyAction: function() {
        this.fire('destroyitem', this.item);
      }
    });
  </script>
</element>
